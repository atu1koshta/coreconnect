<!DOCTYPE html>
<html>

<head>
	<title>Chat WebSocket</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
	<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
	<script type="text/javascript">
		var stompClient = null;
		var heartbeatInterval;

		function setConnected(connected) {
			document.getElementById("connect").disabled = connected;
			document.getElementById("disconnect").disabled = !connected;
			document.getElementById("conversationDiv").style.visibility = connected
				? "visible"
				: "hidden";
			document.getElementById("response").innerHTML = "";
		}

		function connect() {
			var socket = new SockJS("/chat");
			stompClient = Stomp.over(socket);
			stompClient.connect({}, function (frame) {
				setConnected(true);
				console.log("Connected: " + frame);
				stompClient.subscribe("/topic/messages", function (messageOutput) {
					showMessageOutput(JSON.parse(messageOutput.body));
				});
				stompClient.subscribe(
					"/topic/online-devices",
					function (messageOutput) {
						updateOnlineDevices(JSON.parse(messageOutput.body));
					}
				);

				// Start sending heartbeat messages
				heartbeatInterval = setInterval(sendHeartbeat, 30000); // Send heartbeat every 30 seconds
			});
		}

		function sendMessage() {
			var content = document.getElementById("content").value;
			stompClient.send(
				"/app/chat",
				{},
				content);
		}

		function showMessageOutput(messageOutput) {
			var response = document.getElementById("response");
			var p = document.createElement("p");
			p.style.wordWrap = "break-word";
			p.appendChild(
				document.createTextNode(
					messageOutput.sender +
					" [" +
					messageOutput.time +
					"]: " +
					messageOutput.message
				)
			);
			response.appendChild(p);
			
			response.scrollTop = response.scrollHeight;
		}

		function updateOnlineDevices(devices) {
			var onlineDevicesList = document.getElementById("onlineDevicesList");
			onlineDevicesList.innerHTML = "";

			for (var key in devices) {
				var deviceElement = document.createElement("li");
				deviceElement.className = "list-group-item";
				deviceElement.appendChild(
					document.createTextNode(devices[key].ipAddress + " - " + devices[key].deviceName)
				);
				onlineDevicesList.appendChild(deviceElement);
			}
		}

		function sendHeartbeat() {
			if (stompClient != null && stompClient.connected) {
				stompClient.send("/app/heartbeat", {}, "")
			}
		}

		function disconnect() {
			if (stompClient != null) {
				stompClient.disconnect();
			}
			setConnected(false);
			console.log("Disconnected");

			clearInterval(heartbeatInterval);
		}

		function toggleOnlineDevices() {
			var onlineDevices = document.getElementById("onlineDevices");
			if (onlineDevices.style.display === "none") {
				onlineDevices.style.display = "block";
			} else {
				onlineDevices.style.display = "none";
			}
		}
	</script>
	<style>
		@media (max-width: 767.98px) {
			#onlineDevices {
				display: none;
				position: fixed;
				right: 0;
				top: 0;
				width: 75%;
				height: 100%;
				background-color: white;
				z-index: 1000;
				box-shadow: -2px 0 5px rgba(0, 0, 0, 0.5);
				padding: 20px;
			}

			#toggleOnlineDevicesBtn {
				display: block;
				position: fixed;
				right: 20px;
				top: 20px;
				z-index: 1001;
			}

			#conversationDiv {
				padding: 20px;
			}
		}

		@media (min-width: 768px) {
			#toggleOnlineDevicesBtn {
				display: none;
			}

			#onlineDevices {
				display: block !important;
			}
		}
	</style>
</head>

<body onload="disconnect()">
	<div class="container-fluid">
		<div class="row mt-3">
			<div class="col-md-12 text-center">
				<button id="connect" class="btn btn-success" onclick="connect();">Connect</button>
				<button id="disconnect" class="btn btn-danger" disabled="disabled"
					onclick="disconnect();">Disconnect</button>
			</div>
		</div>
		<br />
		<div class="row">
			<div class="col-md-8">
				<div id="conversationDiv">
					<div class="input-group mb-3">
						<input type="text" id="content" class="form-control" placeholder="Write a message..." />
						<div class="input-group-append">
							<button id="sendMessage" class="btn btn-primary" onclick="sendMessage();">Send</button>
						</div>
					</div>
					<div id="response" class="border p-3" style="height: 300px; overflow-y: auto;"></div>
				</div>
			</div>
			<div class="col-md-4">
				<div id="onlineDevices">
					<h2>Online Devices</h2>
					<ul id="onlineDevicesList" class="list-group"></ul>
				</div>
				<button id="toggleOnlineDevicesBtn" class="btn btn-secondary" onclick="toggleOnlineDevices();">Show
					Online Devices</button>
			</div>
		</div>
	</div>
</body>

</html>